<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Архив файлов рекламы</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2em auto; }
    select, button { margin: 0.5em 0; padding: 0.5em; font-size: 1em; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 0.3em 0; }
  </style>
</head>
<body>
  <h1>Скачать ZIP по фильтрам</h1>

  <label>Бренд:
    <select id="brand">
      <option value="">— все —</option>
    </select>
  </label><br>

  <label>Категория:
    <select id="category">
      <option value="">— все —</option>
    </select>
  </label><br>

  <button id="download">Скачать ZIP</button>

  <h2>Найденные файлы:</h2>
  <ul id="file-list"></ul>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGLXlcLn4jmhStOduOZeWL_ZnholxbZ-yDyBzJ8_U_vh789brxlEMg0Jcw4Unzhjr9Di3m8AUlWlO-/pub?gid=0&single=true&output=csv";
    let allData = [];

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: results => {
        allData = results.data.filter(r => r.File && r.File.trim() !== "");
        const brands = [...new Set(allData.map(r => r.Brand))].sort();
        const categories = [...new Set(allData.map(r => r.Category))].sort();

        const brandSelect = document.getElementById("brand");
        brands.forEach(b => brandSelect.add(new Option(b, b)));

        const categorySelect = document.getElementById("category");
        categories.forEach(c => categorySelect.add(new Option(c, c)));

        document.getElementById("brand").addEventListener("change", updateList);
        document.getElementById("category").addEventListener("change", updateList);
      }
    });

    function updateList() {
      const brand = document.getElementById("brand").value;
      const category = document.getElementById("category").value;
      const list = document.getElementById("file-list");
      list.innerHTML = "";

      const filtered = allData.filter(r =>
        (brand === "" || r.Brand === brand) &&
        (category === "" || r.Category === category)
      );

      filtered.forEach((r, idx) => {
        const li = document.createElement("li");
        const url = r.File.replace("/view", "/uc?export=download");
        li.innerHTML = `<a href="${url}" target="_blank">${r.Brand} — ${r.Subcategory} — ${r.Date}</a>`;
        list.appendChild(li);
      });

      document.getElementById("download").onclick = () => downloadZip(filtered);
    }

    async function downloadZip(rows) {
      const zip = new JSZip();
      let count = 1;

      for (const r of rows) {
        try {
          const url = r.File.replace("/view", "/uc?export=download");
          const resp = await fetch(url);
          const blob = await resp.blob();
          const ext = blob.type.includes("png") ? ".png" : ".jpg";
          const filename = `${r.Brand}_${r.Category}_${count}${ext}`;
          zip.file(filename, blob);
          count++;
        } catch (err) {
          console.error("Ошибка загрузки:", r.File, err);
        }
      }

      zip.generateAsync({ type: "blob" })
         .then(content => saveAs(content, "archive.zip"));
    }
  </script>
</body>
</html>
