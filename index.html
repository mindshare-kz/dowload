<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Скачивание фото</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h3>Скачивание фото из Google Таблицы</h3>

  <label for="filter">Фильтр по бренду:</label>
  <select id="filter">
    <option value="">Все</option>
  </select>

  <button id="download">Скачать архив</button>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1XK43QIyOiYnMwQZr9pn5VERiy87uBtRPORpwf7jAOw4/export?format=csv&gid=0";
    let allRows = [];

    // Загружаем CSV
    async function loadCSV() {
      const response = await fetch(sheetUrl);
      const csvText = await response.text();

      Papa.parse(csvText, {
        header: true,
        complete: function(results) {
          allRows = results.data.filter(row => row && Object.values(row).some(v => v)); 
          fillFilterOptions();
        }
      });
    }

    // Заполняем выпадающий список уникальными брендами (например, колонка "Brand")
    function fillFilterOptions() {
      const filter = document.getElementById("filter");
      const brands = [...new Set(allRows.map(row => row.Brand).filter(v => v))];
      brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        filter.appendChild(option);
      });
    }

    // Извлекаем fileId из ссылки Google Drive
    function extractFileId(url) {
      const match = url.match(/\/d\/([^/]+)\//);
      return match ? match[1] : null;
    }

    // Скачиваем и собираем архив
    document.getElementById("download").addEventListener("click", async () => {
      const filterValue = document.getElementById("filter").value;
      const zip = new JSZip();
      let count = 0;

      for (const row of allRows) {
        if (filterValue && row.Brand !== filterValue) continue;

        const driveUrl = row["H"] || row[Object.keys(row)[7]]; // 8-й столбец
        if (!driveUrl) continue;

        const fileId = extractFileId(driveUrl);
        if (!fileId) continue;

        const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
        try {
          const response = await fetch(downloadUrl);
          if (!response.ok) continue;
          const blob = await response.blob();
          const filename = `${row.Brand || "file"}_${count}.jpg`;

          zip.file(filename, blob);
          count++;
        } catch (e) {
          console.error("Ошибка загрузки:", e);
        }
      }

      if (count === 0) {
        alert("Не удалось скачать ни одного файла. Проверьте ссылки в столбце H.");
        return;
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "photos.zip");
    });

    loadCSV();
  </script>
</body>
</html>
