<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Скачать фото из Google Sheets</title>
</head>
<body>
  <h2>Фильтр и скачивание фото</h2>
  <label>Фильтр по значению: <input type="text" id="filterInput"></label>
  <button id="downloadBtn">Скачать архив</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1XK43QIyOiYnMwQZr9pn5VERiy87uBtRPORpwf7jAOw4/export?format=csv&gid=0";

    async function fetchCSV() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      return text.split("\n").map(row => row.split(","));
    }

    async function downloadImages() {
      const filterValue = document.getElementById("filterInput").value.trim().toLowerCase();
      const rows = await fetchCSV();
      const zip = new JSZip();
      let count = 0;

      for (let i = 1; i < rows.length; i++) { // пропускаем заголовок
        const row = rows[i];
        if (!row.length) continue;

        const filterField = row[1]?.toLowerCase() || ""; // например фильтруем по 2 колонке
        const url = row[7]?.trim(); // 8-я колонка (H)

        if (url && (filterValue === "" || filterField.includes(filterValue))) {
          try {
            const response = await fetch(url);
            if (!response.ok) continue;
            const blob = await response.blob();
            const ext = url.split('.').pop().split('?')[0];
            zip.file(`file_${i}.${ext}`, blob);
            count++;
          } catch (e) {
            console.error("Ошибка скачивания:", url, e);
          }
        }
      }

      if (count === 0) {
        alert("Не найдено файлов для скачивания");
        return;
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "images.zip");
    }

    document.getElementById("downloadBtn").addEventListener("click", downloadImages);
  </script>
</body>
</html>
