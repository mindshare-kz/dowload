<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Фильтр и архив фото</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h2>Фильтрация фото</h2>

  <label>Категория:
    <select id="categoryFilter">
      <option value="">Все</option>
    </select>
  </label>

  <label>Субкатегория:
    <select id="subcategoryFilter">
      <option value="">Все</option>
    </select>
  </label>

  <label>Бренд:
    <select id="brandFilter">
      <option value="">Все</option>
    </select>
  </label>

  <button onclick="downloadZip()">Скачать архив</button>

  <h3>Найденные файлы:</h3>
  <ul id="fileList"></ul>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGLXlcLn4jmhStOduOZeWL_ZnholxbZ-yDyBzJ8_U_vh789brxlEMg0Jcw4Unzhjr9Di3m8AUlWlO-/pub?gid=0&single=true&output=csv";
    let data = [];

    // Загружаем CSV
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        data = results.data;
        populateFilters();
        renderList();
      }
    });

    function populateFilters() {
      fillSelect("categoryFilter", [...new Set(data.map(d => d.Category))]);
      fillSelect("subcategoryFilter", [...new Set(data.map(d => d.Subcategory))]);
      fillSelect("brandFilter", [...new Set(data.map(d => d.Brand))]);
    }

    function fillSelect(id, values) {
      const select = document.getElementById(id);
      values.filter(v => v).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
      select.addEventListener("change", renderList);
    }

    function renderList() {
      const cat = document.getElementById("categoryFilter").value;
      const sub = document.getElementById("subcategoryFilter").value;
      const brand = document.getElementById("brandFilter").value;

      const filtered = data.filter(d =>
        (!cat || d.Category === cat) &&
        (!sub || d.Subcategory === sub) &&
        (!brand || d.Brand === brand)
      );

      const list = document.getElementById("fileList");
      list.innerHTML = "";
      filtered.forEach(d => {
        const li = document.createElement("li");
        const fileId = extractFileId(d.File);
        const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
        li.innerHTML = `<a href="${url}" target="_blank">${d.Brand} — ${d.Category} (${d.Subcategory})</a>`;
        list.appendChild(li);
      });
    }

    function extractFileId(url) {
      const match = url.match(/[-\w]{25,}/);
      return match ? match[0] : null;
    }

    async function downloadZip() {
      const cat = document.getElementById("categoryFilter").value;
      const sub = document.getElementById("subcategoryFilter").value;
      const brand = document.getElementById("brandFilter").value;

      const filtered = data.filter(d =>
        (!cat || d.Category === cat) &&
        (!sub || d.Subcategory === sub) &&
        (!brand || d.Brand === brand)
      );

      if (filtered.length === 0) {
        alert("Нет файлов для скачивания!");
        return;
      }

      const zip = new JSZip();

      for (const d of filtered) {
        const fileId = extractFileId(d.File);
        if (!fileId) continue;
        const url = `https://drive.google.com/uc?export=download&id=${fileId}`;

        try {
          const response = await fetch(url);
          const blob = await response.blob();
          const ext = blob.type.split("/")[1] || "jpg";
          zip.file(`${d.Brand}_${fileId}.${ext}`, blob);
        } catch (e) {
          console.error("Ошибка загрузки", url, e);
        }
      }

      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, "archive.zip");
    }
  </script>
</body>
</html>
