<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Скачивание фотоархива</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h2>Скачивание фотоархива</h2>
  <button onclick="downloadArchive()">Скачать архив</button>
  <p id="status"></p>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGLXlcLn4jmhStOduOZeWL_ZnholxbZ-yDyBzJ8_U_vh789brxlEMg0Jcw4Unzhjr9Di3m8AUlWlO-/pub?gid=0&single=true&output=csv";

async function downloadArchive() {
  document.getElementById("status").innerText = "Загружаем список файлов...";

  // 1. Загружаем CSV
  let res = await fetch(csvUrl);
  let text = await res.text();

  // 2. Парсим CSV (берём только колонку File или ссылку)
  let rows = text.split("\n").map(r => r.split(","));
  let header = rows[0];
  let fileColIndex = header.findIndex(h => h.toLowerCase().includes("file"));

  let links = rows.slice(1).map(r => r[fileColIndex]).filter(Boolean);

  // 3. Преобразуем ссылки в прямые download-ссылки
  let ids = links.map(link => {
    let match = link.match(/[-\w]{25,}/);
    return match ? match[0] : null;
  }).filter(Boolean);

  let downloadLinks = ids.map(id => `https://drive.google.com/uc?export=download&id=${id}`);

  if (downloadLinks.length === 0) {
    document.getElementById("status").innerText = "Не найдено ни одного файла.";
    return;
  }

  document.getElementById("status").innerText = `Найдено файлов: ${downloadLinks.length}. Скачиваем...`;

  // 4. Скачиваем и кладём в ZIP
  let zip = new JSZip();
  let count = 0;

  for (let i = 0; i < downloadLinks.length; i++) {
    try {
      let resp = await fetch(downloadLinks[i]);
      let blob = await resp.blob();
      zip.file(`file_${i+1}.jpg`, blob); // все как .jpg (или можно определять mime)
      count++;
      document.getElementById("status").innerText = `Загружено: ${count}/${downloadLinks.length}`;
    } catch (e) {
      console.error("Ошибка загрузки", downloadLinks[i], e);
    }
  }

  // 5. Сохраняем ZIP
  let content = await zip.generateAsync({ type: "blob" });
  saveAs(content, "archive.zip");

  document.getElementById("status").innerText = "Готово! Архив скачан.";
}
</script>
</body>
</html>
