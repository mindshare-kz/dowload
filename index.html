<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Скачать фото из таблицы</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h2>Фильтр и скачивание фото</h2>
  <div id="filters"></div>
  <button id="download">Скачать архив</button>

  <script>
    // ссылка на CSV публикации Google Sheets
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGLXlcLn4jmhStOduOZeWL_ZnholxbZ-yDyBzJ8_U_vh789brxlEMg0Jcw4Unzhjr9Di3m8AUlWlO-/pub?gid=0&single=true&output=csv";

    let tableData = [];

    // функция для приведения ссылок Google Drive к прямому скачиванию
    function normalizeLink(url) {
      if (!url) return null;
      const match = url.match(/\/d\/(.*?)(?:\/|$)/);
      if (match) {
        return "https://drive.google.com/uc?export=download&id=" + match[1];
      }
      return url; // если уже прямая ссылка
    }

    // загрузка CSV
    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        tableData = results.data;
        buildFilters(results.meta.fields);
      }
    });

    // построение фильтров
    function buildFilters(columns) {
      const container = document.getElementById("filters");
      columns.forEach(col => {
        if (col !== "H") { // не делаем фильтр для ссылок
          const label = document.createElement("label");
          label.textContent = col + ": ";
          const select = document.createElement("select");
          select.dataset.column = col;

          const values = [...new Set(tableData.map(r => r[col]).filter(Boolean))];
          select.innerHTML = `<option value="">(Все)</option>` +
                             values.map(v => `<option value="${v}">${v}</option>`).join("");
          label.appendChild(select);
          container.appendChild(label);
          container.appendChild(document.createElement("br"));
        }
      });
    }

    // фильтрация
    function applyFilters() {
      const selects = document.querySelectorAll("#filters select");
      let filtered = tableData;
      selects.forEach(sel => {
        if (sel.value) {
          filtered = filtered.filter(r => r[sel.dataset.column] === sel.value);
        }
      });
      return filtered;
    }

    // скачивание архива
    document.getElementById("download").addEventListener("click", async () => {
      const filtered = applyFilters();
      if (!filtered.length) {
        alert("Нет строк для скачивания");
        return;
      }

      const zip = new JSZip();
      let count = 0;

      for (const row of filtered) {
        const url = normalizeLink(row["H"]);
        if (!url) continue;

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Ошибка скачивания " + url);
          const blob = await response.blob();
          const name = (row["Name"] || "file") + "_" + (count+1) + ".jpg";
          zip.file(name, blob);
          count++;
        } catch (e) {
          console.error(e);
        }
      }

      if (count === 0) {
        alert("Не удалось скачать ни одного файла");
        return;
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "photos.zip");
    });
  </script>
</body>
</html>
