<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Скачивание фото из Google Drive</title>
</head>
<body>
  <h2>Фильтр и скачивание фото</h2>

  <label for="filter">Выберите бренд:</label>
  <select id="filter"></select>
  <button id="download">Скачать архив</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1XK43QIyOiYnMwQZr9pn5VERiy87uBtRPORpwf7jAOw4/export?format=csv&gid=0";

    let rows = [];

    async function loadData() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      rows = text.split("\n").map(r => r.split(","));
      
      const brands = [...new Set(rows.slice(1).map(r => r[0]))]; // первый столбец = бренд
      const filter = document.getElementById("filter");
      brands.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        filter.appendChild(opt);
      });
    }

    function fixLink(url) {
      const match = url.match(/\/d\/(.*?)\//);
      return match ? `https://drive.google.com/uc?export=download&id=${match[1]}` : null;
    }

    document.getElementById("download").addEventListener("click", async () => {
      const brand = document.getElementById("filter").value;
      const filtered = rows.filter(r => r[0] === brand);

      if (filtered.length === 0) {
        alert("Нет файлов для выбранного фильтра");
        return;
      }

      const zip = new JSZip();
      let count = 0;

      for (let i = 0; i < filtered.length; i++) {
        const url = fixLink(filtered[i][7]); // 8 колонка (H)
        if (!url) continue;

        try {
          const res = await fetch(url);
          const blob = await res.blob();
          zip.file(`image_${i+1}.jpg`, blob);
          count++;
        } catch (e) {
          console.log("Ошибка загрузки:", url);
        }
      }

      if (count === 0) {
        alert("Не удалось скачать ни одного файла");
        return;
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, brand + "_photos.zip");
    });

    loadData();
  </script>
</body>
</html>
