<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Архив рекламы</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
  <h1>Скачать архив файлов</h1>
  
  <label for="brand">Выбери бренд:</label>
  <select id="brand"></select>
  
  <button id="download">Скачать ZIP</button>
  
  <ul id="file-list"></ul>

  <script>
    // ССЫЛКА НА CSV (замени на свою!)
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGLXlcLn4jmhStOduOZeWL_ZnholxbZ-yDyBzJ8_U_vh789brxlEMg0Jcw4Unzhjr9Di3m8AUlWlO-/pub?gid=0&single=true&output=csv";

    let allData = [];

    // Загружаем CSV
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data;

        // Получаем список брендов
        const brands = [...new Set(allData.map(row => row.Brand))];
        const brandSelect = document.getElementById("brand");
        brands.forEach(b => {
          const opt = document.createElement("option");
          opt.value = b;
          opt.textContent = b;
          brandSelect.appendChild(opt);
        });

        brandSelect.addEventListener("change", updateFileList);
      }
    });

    // Обновление списка файлов по бренду
    function updateFileList() {
      const brand = document.getElementById("brand").value;
      const list = document.getElementById("file-list");
      list.innerHTML = "";

      const rows = allData.filter(r => r.Brand === brand);
      rows.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r.File;
        list.appendChild(li);
      });

      document.getElementById("download").onclick = () => downloadZip(rows);
    }

    // Скачивание ZIP
    async function downloadZip(rows) {
      const zip = new JSZip();
      let count = 0;

      for (const row of rows) {
        try {
          const url = row.File.replace("/view", "/uc?export=download"); // Google Drive direct link
          const response = await fetch(url);
          const blob = await response.blob();
          const filename = row.Brand + "_" + (count++) + ".jpg";
          zip.file(filename, blob);
        } catch (e) {
          console.error("Ошибка загрузки", row.File, e);
        }
      }

      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, "archive.zip");
    }
  </script>
</body>
</html>
